import streamlit as st
from openai import OpenAI
import time

# -----------------------------
# Page Config
# -----------------------------
st.set_page_config(page_title="KisanVaani - Telugu Voice Assistant", page_icon="üåæ")

st.title("üåæ KisanVaani ‚Äì Telugu Voice Assistant")

st.markdown("### ‡∞∞‡±à‡∞§‡±Å‡∞≤ ‡∞ï‡±ã‡∞∏‡∞Ç ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å‡∞≤‡±ã AI ‡∞∏‡∞π‡∞æ‡∞Ø‡∞ï‡±Å‡∞°‡±Å")
st.write("‡∞™‡∞Ç‡∞ü‡∞≤‡±Å, ‡∞™‡±Å‡∞∞‡±Å‡∞ó‡±Å‡∞≤‡±Å, ‡∞Æ‡∞Ç‡∞¶‡±Å‡∞≤ ‡∞Æ‡±ã‡∞§‡∞æ‡∞¶‡±Å, ‡∞™‡∞∂‡±Å‡∞™‡±ã‡∞∑‡∞£, ‡∞∞‡±Å‡∞£‡∞æ‡∞≤‡±Å, ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ï‡±Ü‡∞ü‡±ç ‡∞ß‡∞∞‡∞≤‡±Å, ‡∞™‡±ç‡∞∞‡∞≠‡±Å‡∞§‡±ç‡∞µ ‡∞™‡∞•‡∞ï‡∞æ‡∞≤‡±Å ‚Äî ‡∞Ö‡∞®‡±ç‡∞®‡∞ø‡∞Ç‡∞ü‡∞ø‡∞ï‡±Ä ‡∞∏‡∞Æ‡∞æ‡∞ß‡∞æ‡∞®‡∞Ç ‡∞á‡∞∏‡±ç‡∞§‡±Å‡∞Ç‡∞¶‡∞ø.")

# -----------------------------
# OpenAI Client
# -----------------------------
client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"])

# -----------------------------
# AI Function
# -----------------------------
def ai_respond(question):
    try:
        time.sleep(1)  # Prevent rate-limit burst

        SYSTEM_PROMPT = """
        ‡∞Æ‡±Ä‡∞∞‡±Å ‡∞∞‡±à‡∞§‡±Å‡∞≤ ‡∞ï‡±ã‡∞∏‡∞Ç ‡∞∞‡±Ç‡∞™‡±ä‡∞Ç‡∞¶‡∞ø‡∞Ç‡∞ö‡∞ø‡∞® AI ‡∞∏‡∞π‡∞æ‡∞Ø‡∞ï‡±Å‡∞°‡±Å.
        ‡∞™‡∞Ç‡∞ü‡∞≤‡±Å, ‡∞™‡±Å‡∞∞‡±Å‡∞ó‡±Å‡∞≤‡±Å, ‡∞Æ‡∞Ç‡∞¶‡±Å‡∞≤ ‡∞Æ‡±ã‡∞§‡∞æ‡∞¶‡±Å, ‡∞™‡∞∂‡±Å‡∞™‡±ã‡∞∑‡∞£,
        ‡∞∞‡±Å‡∞£‡∞æ‡∞≤‡±Å, ‡∞™‡±ç‡∞∞‡∞≠‡±Å‡∞§‡±ç‡∞µ ‡∞™‡∞•‡∞ï‡∞æ‡∞≤‡±Å, ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ï‡±Ü‡∞ü‡±ç ‡∞ß‡∞∞‡∞≤‡±Å ‚Äî
        ‡∞Ö‡∞®‡±ç‡∞®‡∞ø‡∞ü‡∞ø‡∞ï‡±Ä ‡∞∏‡∞∞‡∞≥‡∞Æ‡±à‡∞® ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å ‡∞≠‡∞æ‡∞∑‡∞≤‡±ã ‡∞∏‡∞Æ‡∞æ‡∞ß‡∞æ‡∞®‡∞Ç ‡∞á‡∞µ‡±ç‡∞µ‡∞Ç‡∞°‡∞ø.
        """

        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT},
                {"role": "user", "content": question}
            ],
            temperature=0.4,
            max_tokens=400
        )

        return response.choices[0].message.content

    except Exception:
        return "‚ö†Ô∏è ‡∞™‡±ç‡∞∞‡∞∏‡±ç‡∞§‡±Å‡∞§‡∞Ç ‡∞∏‡∞∞‡±ç‡∞µ‡∞∞‡±ç ‡∞¨‡∞ø‡∞ú‡±Ä‡∞ó‡∞æ ‡∞â‡∞Ç‡∞¶‡∞ø. ‡∞ï‡±ä‡∞Ç‡∞ö‡±Ü‡∞Ç ‡∞∏‡±á‡∞™‡∞ü‡∞ø ‡∞§‡∞∞‡±ç‡∞µ‡∞æ‡∞§ ‡∞Æ‡∞≥‡±ç‡∞≤‡±Ä ‡∞™‡±ç‡∞∞‡∞Ø‡∞§‡±ç‡∞®‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø."

# -----------------------------
# User Input Section
# -----------------------------
user_question = st.text_input("‡∞Æ‡±Ä ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞® ‡∞Ö‡∞°‡∞ó‡∞Ç‡∞°‡∞ø:")

if user_question:
    st.success(f"‡∞Æ‡±Ä ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®: {user_question}")

    answer = ai_respond(str(user_question))
    st.info(f"‡∞∏‡∞Æ‡∞æ‡∞ß‡∞æ‡∞®‡∞Ç: {answer}")
